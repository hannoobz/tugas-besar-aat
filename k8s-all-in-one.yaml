---
# ConfigMap for Warga Database
apiVersion: v1
kind: ConfigMap
metadata:
  name: warga-db-config
data:
  DB_HOST: "postgres-warga"
  DB_PORT: "5432"
  DB_USER: "postgres"
  DB_PASSWORD: "postgres"
  DB_NAME: "wargadb"

---
# ConfigMap for Admin Database
apiVersion: v1
kind: ConfigMap
metadata:
  name: admin-db-config
data:
  DB_HOST: "postgres-admin"
  DB_PORT: "5432"
  DB_USER: "postgres"
  DB_PASSWORD: "postgres"
  DB_NAME: "admindb"

---
# ConfigMap for Laporan Database
apiVersion: v1
kind: ConfigMap
metadata:
  name: laporan-db-config
data:
  DB_HOST: "postgres-laporan"
  DB_PORT: "5432"
  DB_USER: "postgres"
  DB_PASSWORD: "postgres"
  DB_NAME: "laporandb"

---
# JWT Config (shared)
apiVersion: v1
kind: ConfigMap
metadata:
  name: jwt-config
data:
  JWT_SECRET: "your-super-secret-jwt-key-change-this-in-production"
  JWT_REFRESH_SECRET: "your-super-secret-refresh-key-change-this-in-production"
  JWT_ACCESS_EXPIRY: "15m"
  JWT_REFRESH_EXPIRY: "7d"

---
# PostgreSQL Warga Database Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-warga
  labels:
    app: postgres-warga
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-warga
  template:
    metadata:
      labels:
        app: postgres-warga
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "wargadb"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          value: "postgres"
        volumeMounts:
        - name: init-script
          mountPath: /docker-entrypoint-initdb.d
        - name: data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: init-script
        configMap:
          name: warga-db-init
      - name: data
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: postgres-warga
spec:
  type: ClusterIP
  selector:
    app: postgres-warga
  ports:
  - port: 5432
    targetPort: 5432

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: warga-db-init
data:
  init.sql: |
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        nik VARCHAR(16) UNIQUE NOT NULL,
        nama VARCHAR(255) NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE TABLE IF NOT EXISTS refresh_tokens (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        token VARCHAR(500) UNIQUE NOT NULL,
        expires_at TIMESTAMP NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        revoked BOOLEAN DEFAULT FALSE
    );
    
    CREATE INDEX IF NOT EXISTS idx_users_nik ON users(nik);
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

---
# PostgreSQL Admin Database Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-admin
  labels:
    app: postgres-admin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-admin
  template:
    metadata:
      labels:
        app: postgres-admin
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "admindb"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          value: "postgres"
        volumeMounts:
        - name: init-script
          mountPath: /docker-entrypoint-initdb.d
        - name: data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: init-script
        configMap:
          name: admin-db-init
      - name: data
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: postgres-admin
spec:
  type: ClusterIP
  selector:
    app: postgres-admin
  ports:
  - port: 5432
    targetPort: 5432

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: admin-db-init
data:
  init.sql: |
    CREATE TYPE divisi_enum AS ENUM ('kebersihan', 'kesehatan', 'fasilitas umum', 'kriminalitas');
    
    CREATE TABLE IF NOT EXISTS users (
        nip VARCHAR(18) PRIMARY KEY,
        nama VARCHAR(255) NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        divisi divisi_enum NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE TABLE IF NOT EXISTS refresh_tokens (
        id SERIAL PRIMARY KEY,
        user_nip VARCHAR(18) NOT NULL REFERENCES users(nip) ON DELETE CASCADE,
        token VARCHAR(500) UNIQUE NOT NULL,
        expires_at TIMESTAMP NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        revoked BOOLEAN DEFAULT FALSE
    );
    
    CREATE INDEX IF NOT EXISTS idx_users_nip ON users(nip);
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
    CREATE INDEX IF NOT EXISTS idx_users_divisi ON users(divisi);

---
# PostgreSQL Laporan Database Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-laporan
  labels:
    app: postgres-laporan
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-laporan
  template:
    metadata:
      labels:
        app: postgres-laporan
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "laporandb"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          value: "postgres"
        volumeMounts:
        - name: init-script
          mountPath: /docker-entrypoint-initdb.d
        - name: data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: init-script
        configMap:
          name: laporan-db-init
      - name: data
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: postgres-laporan
spec:
  type: ClusterIP
  selector:
    app: postgres-laporan
  ports:
  - port: 5432
    targetPort: 5432

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: laporan-db-init
data:
  init.sql: |
    CREATE TABLE IF NOT EXISTS laporan (
        id SERIAL PRIMARY KEY,
        title VARCHAR(255) NOT NULL,
        description TEXT NOT NULL,
        user_id INTEGER,
        status VARCHAR(50) NOT NULL DEFAULT 'pending',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE INDEX IF NOT EXISTS idx_laporan_status ON laporan(status);
    CREATE INDEX IF NOT EXISTS idx_laporan_user_id ON laporan(user_id);

---
# Service Auth Warga Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-auth-warga
  labels:
    app: service-auth-warga
spec:
  replicas: 2
  selector:
    matchLabels:
      app: service-auth-warga
  template:
    metadata:
      labels:
        app: service-auth-warga
    spec:
      containers:
      - name: service-auth-warga
        image: service-auth-warga:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8081
        env:
        - name: PORT
          value: "8081"
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_PORT
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_PASSWORD
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_NAME
        - name: JWT_SECRET
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_SECRET
        - name: JWT_REFRESH_SECRET
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_REFRESH_SECRET
        - name: JWT_ACCESS_EXPIRY
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_ACCESS_EXPIRY
        - name: JWT_REFRESH_EXPIRY
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_REFRESH_EXPIRY
        livenessProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: service-auth-warga
spec:
  type: NodePort
  selector:
    app: service-auth-warga
  ports:
  - port: 8081
    targetPort: 8081
    nodePort: 30084

---
# Service Auth Admin Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-auth-admin
  labels:
    app: service-auth-admin
spec:
  replicas: 2
  selector:
    matchLabels:
      app: service-auth-admin
  template:
    metadata:
      labels:
        app: service-auth-admin
    spec:
      containers:
      - name: service-auth-admin
        image: service-auth-admin:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 3001
        env:
        - name: PORT
          value: "3001"
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_PORT
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_PASSWORD
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_NAME
        - name: JWT_SECRET
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_SECRET
        - name: JWT_REFRESH_SECRET
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_REFRESH_SECRET
        - name: JWT_ACCESS_EXPIRY
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_ACCESS_EXPIRY
        - name: JWT_REFRESH_EXPIRY
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_REFRESH_EXPIRY
        livenessProbe:
          httpGet:
            path: /health
            port: 3001
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 3001
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: service-auth-admin
spec:
  type: NodePort
  selector:
    app: service-auth-admin
  ports:
  - port: 3001
    targetPort: 3001
    nodePort: 30085

---
# Service Pembuat Laporan (Go) Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-pembuat-laporan
  labels:
    app: service-pembuat-laporan
spec:
  replicas: 3
  selector:
    matchLabels:
      app: service-pembuat-laporan
  template:
    metadata:
      labels:
        app: service-pembuat-laporan
    spec:
      containers:
      - name: service-pembuat-laporan
        image: service-pembuat-laporan:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        env:
        - name: PORT
          value: "8080"
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_PORT
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_PASSWORD
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_NAME
        - name: JWT_SECRET
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_SECRET
        - name: JWT_REFRESH_SECRET
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_REFRESH_SECRET
        - name: JWT_ACCESS_EXPIRY
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_ACCESS_EXPIRY
        - name: JWT_REFRESH_EXPIRY
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_REFRESH_EXPIRY
        - name: AUTH_DB_HOST
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_HOST
        - name: AUTH_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_PORT
        - name: AUTH_DB_USER
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_USER
        - name: AUTH_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_PASSWORD
        - name: AUTH_DB_NAME
          valueFrom:
            configMapKeyRef:
              name: warga-db-config
              key: DB_NAME
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: service-pembuat-laporan
spec:
  type: NodePort
  selector:
    app: service-pembuat-laporan
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30082

---
# Service Penerima Laporan (Node.js) Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-penerima-laporan
  labels:
    app: service-penerima-laporan
spec:
  replicas: 1
  selector:
    matchLabels:
      app: service-penerima-laporan
  template:
    metadata:
      labels:
        app: service-penerima-laporan
    spec:
      containers:
      - name: service-penerima-laporan
        image: service-penerima-laporan:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 3000
        env:
        - name: PORT
          value: "3000"
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_PORT
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_PASSWORD
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: laporan-db-config
              key: DB_NAME
        - name: JWT_SECRET
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_SECRET
        - name: JWT_REFRESH_SECRET
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_REFRESH_SECRET
        - name: JWT_ACCESS_EXPIRY
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_ACCESS_EXPIRY
        - name: JWT_REFRESH_EXPIRY
          valueFrom:
            configMapKeyRef:
              name: jwt-config
              key: JWT_REFRESH_EXPIRY
        - name: AUTH_DB_HOST
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_HOST
        - name: AUTH_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_PORT
        - name: AUTH_DB_USER
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_USER
        - name: AUTH_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_PASSWORD
        - name: AUTH_DB_NAME
          valueFrom:
            configMapKeyRef:
              name: admin-db-config
              key: DB_NAME
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: service-penerima-laporan
spec:
  type: NodePort
  selector:
    app: service-penerima-laporan
  ports:
  - port: 3000
    targetPort: 3000
    nodePort: 30083

---
# Client User (Frontend) Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: client-user
  labels:
    app: client-user
spec:
  replicas: 1
  selector:
    matchLabels:
      app: client-user
  template:
    metadata:
      labels:
        app: client-user
    spec:
      containers:
      - name: client-user
        image: client-user:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 80

---
apiVersion: v1
kind: Service
metadata:
  name: client-user
spec:
  type: NodePort
  selector:
    app: client-user
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080

---
# Client Admin (Frontend) Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: client-admin
  labels:
    app: client-admin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: client-admin
  template:
    metadata:
      labels:
        app: client-admin
    spec:
      containers:
      - name: client-admin
        image: client-admin:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 80

---
apiVersion: v1
kind: Service
metadata:
  name: client-admin
spec:
  type: NodePort
  selector:
    app: client-admin
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30081

---
# Horizontal Pod Autoscaler for Service Pembuat Laporan
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: service-pembuat-laporan-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: service-pembuat-laporan
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 50
        periodSeconds: 15
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 2
        periodSeconds: 15
      selectPolicy: Max
---
# Ingress Resource for Frontend Routing
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: laporan-system-ingress
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  ingressClassName: nginx
  rules:
  - host: localhost
    http:
      paths:
      # User Client Frontend (rewrite /user/* to /*)
      - path: /user(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: client-user
            port:
              number: 80
      
      # Admin Client Frontend (rewrite /admin/* to /*)
      - path: /admin(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: client-admin
            port:
              number: 80
      
      # Root redirect to user client (NO rewrite)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: client-user
            port:
              number: 80

---
# API Ingress with rewrite
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: laporan-api-ingress
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: $1
spec:
  ingressClassName: nginx
  rules:
  - host: localhost
    http:
      paths:
      # User Auth Service - Health endpoint
      # /api/warga/health -> /health
      - path: /api/warga(/health.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: service-auth-warga
            port:
              number: 8081
      
      # User Authentication (service-auth-warga)
      # /api/warga/auth/login -> /auth/login
      - path: /api/warga(/auth.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: service-auth-warga
            port:
              number: 8081
      
      # User Report Creation (service-pembuat-laporan)
      # /api/warga/laporan -> /laporan
      - path: /api/warga(/laporan.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: service-pembuat-laporan
            port:
              number: 8080
      
      # Admin Auth Service - Health endpoint
      # /api/admin/health -> /health
      - path: /api/admin(/health.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: service-auth-admin
            port:
              number: 3001
      
      # Admin Authentication (service-auth-admin)
      # /api/admin/auth/login -> /auth/login
      - path: /api/admin(/auth.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: service-auth-admin
            port:
              number: 3001
      
      # Admin Report Management (service-penerima-laporan)
      # /api/admin/laporan -> /laporan
      - path: /api/admin(/laporan.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: service-penerima-laporan
            port:
              number: 3000